{% extends 'layout.html' %}
{% load staticfiles %}
{% block title %}{{ room_name }}{% endblock %}
{% block contents %}

        {% if not is_active %}
            <h3 class="text-center">Sorry this room is not active</h3>
        {% elif not has_access %}
            <h3 class="text-center">You have no permission in this room</h3>
        {% endif %}

        {% if is_active and has_access %}

            <div class="row">
                <div class="col-md-8">
                    <div id="meet"></div>
                </div>
                <div class="col-md-4">
                    <div id="holder"></div>
                    <button onclick="sendPlainMsg()">Send plain msg</button>
                </div>
            </div>

        <script src='{% static "js/external_api.min.js" %}'></script>
        <script type="text/javascript">
            const domain = '{{ domain }}';
            const options = {
                roomName: '{{ room_obj.name }}',
                width: '100%',
                height: 700,
                parentNode: document.querySelector('#meet'),
                jwt: '{{ token }}'

            };
            var holderDiv = document.getElementById("holder");
            const api = new JitsiMeetExternalAPI(domain, options);
            api.executeCommand('displayName', '{{ user.profile.name }}');
            api.addEventListener('videoConferenceLeft', function () {
                window.location = "{% url 'room:room_list' %}";
            });
            api.addEventListener('endpointTextMessageReceived', function (data) {
                console.log("endpointTextMessageReceived", data);
            });
            api.addEventListener('participantJoined', function (data) {
                console.log("participantJoined", data);
                var para = document.createElement("p");
                para.innerHTML = data['displayName'] + " <button onclick='sendMsg(\""+data['id']+"\")'> Send Msg</button> ";
                holderDiv.appendChild(para);
            });
            api.addEventListener('on-stage-participant-changed', function (data) {
                console.log("on-stage-participant-changed", data);
            });
            api.addEventListener('incomingMessage', function (data) {
                console.log("incomingMessage",data);
            });
            api.addEventListener('participantPropertyChanged', function(data) {
                console.log("participantPropertyChanged", data)
            });
            api.addEventListener('participantLeft', function(data) {
                console.log('participantLeft', data);
            });

            function sendMsg(id) {
                api.executeCommand('sendEndpointTextMessage', {"to": id, "text": "hello"});
            }
            function sendPlainMsg() {
                api.executeCommand('sendPlainTextMessage', 'This is a plain Text msg from nati');
            }

        </script>
        {% endif %}
{% endblock %}