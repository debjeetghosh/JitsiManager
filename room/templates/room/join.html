{% extends 'layout.html' %}
{% load staticfiles %}
{% block title %}{{ room_name }}{% endblock %}
{% block contents %}

        {% if not is_active %}
            <h3 class="text-center">Sorry this room is not active</h3>
        {% elif not has_access %}
            <h3 class="text-center">You have no permission in this room</h3>
        {% endif %}

        {% if is_active and has_access %}

            <div class="row">
                <div class="col-md-12">
                    {% if room_obj.start_time and room_obj.max_length > 0 %}
                        <h1>Time remaining: <span id="remaining_time_span"></span></h1>
                    {% endif %}
                    <div id="meet"></div>
                </div>

            </div>

        <script src='https://talk.gomeeting.org/libs/external_api.min.js'></script>
        <script type="text/javascript">
            const domain = '{{ domain }}';
            const options = {
                roomName: '{{ room_obj.room_id }}',
                width: '100%',
                height: 700,
                parentNode: document.querySelector('#meet'),
                jwt: '{{ token }}'

            };
            const api = new JitsiMeetExternalAPI(domain, options);
            api.executeCommand('displayName', '{{ user.profile.name }}');

            api.executeCommand('subject', '{{ room_obj.name }}');

            api.addEventListener('videoConferenceLeft', function () {
                window.location = "{% url 'room:room_list' %}";
            });

        </script>
        {% endif %}
{% endblock %}
{% block page_scripts %}
    <script type="text/javascript">
        $(function () {
            {% if room_obj.start_time and room_obj.max_length > 0 %}
                var start_time = {{ room_obj.start_time }};
                var end_time = {{ room_obj.start_time }} + parseInt({{ room_obj.max_length }})*60*1000;
                setInterval(function(){
                    if(end_time-moment().valueOf()>0) {
                        var remaining_time = moment.duration(end_time - moment().valueOf(), 'milliseconds');
                        $("#remaining_time_span").text(remaining_time.minutes() + " minutes" + remaining_time.seconds() + " seconds");
                    }
                    else{
                        $("#remaining_time_span").text("Finished");
                        window.location = "{% url 'room:room_list' %}";
                    }
                }, 1000);
            {% endif %}
        });
    </script>
{% endblock %}